{{- $argocd := index .Values "argo-cd" -}}
{{- if and $argocd.server.ingress.enabled (eq $argocd.server.ingress.controller "generic") }}
# Restrict Argo CD to VPN (Tailnet) traffic only.
# Primary allow: 100.64.0.0/10 (Tailscale/Headscale).
# Note: Avoid adding cluster CIDRs (e.g. k3s pod CIDR 10.42.0.0/16) here. kube-proxy can SNAT
# public traffic to those ranges, which would accidentally make Argo CD publicly accessible.
# See docs/vpn-headscale.md. Remove router.middlewares from server.ingress.annotations to disable.
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: argocd-vpn-only
  namespace: {{ .Release.Namespace | quote }}
  labels:
    app.kubernetes.io/name: argocd-wrapper
    app.kubernetes.io/component: vpn-only
spec:
  ipAllowList:
    sourceRange:
      - 100.64.0.0/10
      - 127.0.0.1/32    # VPS localhost (for local curl/health checks)
{{- end }}
