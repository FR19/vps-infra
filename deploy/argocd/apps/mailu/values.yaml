# Wrapper chart values. Mailu subchart values are under "mailu:".
# Top-level domain/hostnames are required so the Mailu chart sees .Values.domain when it validates (NOTES.txt).
# Top-level ingress.enabled: false so the Mailu chart (when used as main or subchart) does not create its Ingress;
# we use templates/mailu-web-ingressroute.yaml (Traefik IngressRoute) instead.
domain: tukangketik.net
hostnames:
  - mail.tukangketik.net
ingress:
  enabled: false

mailu:
  domain: tukangketik.net
  revisionHistoryLimit: 2
  hostnames:
    - mail.tukangketik.net

  secretKey: ""
  existingSecret: mailu-secret

  # Initial admin: login at https://mail.tukangketik.net/admin as admin@tukangketik.net
  # Create secret first: kubectl create secret generic mailu-initial-account -n mailu --from-literal=initial-account-password='YourPassword'
  initialAccount:
    enabled: true
    username: admin
    domain: tukangketik.net
    existingSecret: mailu-initial-account
    existingSecretPasswordKey: initial-account-password
    mode: create

  subnet: 10.42.1.0/24

  # cert-manager Certificate (templates/mailu-certificate.yaml) creates secret "mailu-certificates"
  # so the Mailu front pod can mount /certs. Override issuer if needed.
  certManager:
    issuer: letsencrypt-prod

  # Disabled: chart ingress uses backend port "https" (443), causing 502 when TLS_FLAVOR=notls.
  # Our templates/mailu-web-ingress.yaml uses port 80.
  ingress:
    enabled: false

  persistence:
    enabled: true
    size: 10Gi

  # Authentik: forward auth + proxy auth headers. When enabled, Traefik IngressRoute
  # uses ForwardAuth to Authentik and Mailu trusts PROXY_AUTH_HEADER from Traefik.
  authentik:
    enabled: true
    # URL Traefik calls for forward auth. In-cluster avoids Host being overwritten (fixes 404).
    forwardAuthUrl: "http://ak-outpost-authentik-embedded-outpost.auth.svc.cluster.local/outpost.goauthentik.io/auth/traefik"
    # External URL (use if in-cluster fails or you need auth via public host):
    # forwardAuthUrl: "https://auth.tukangketik.net/outpost.goauthentik.io/auth/traefik"
    # Backend for /outpost.goauthentik.io/* on the mail host (callback). Requires Traefik allowCrossNamespace=true.
    backendNamespace: auth
    backendServiceName: ak-outpost-authentik-embedded-outpost
    backendPort: 9000
    # CIDRs to trust for proxy auth. Must include the IPs Traefik uses when calling Mailu (pod or node CIDR).
    # See docs/mailu-install.md or docs/authentik-mailu-setup.md for how to find your cluster's range.
    proxyAuthWhitelist: "10.42.1.0/24"
    # Header set by Authentik outpost; Mailu uses this as the authenticated user email.
    proxyAuthHeader: "X-Authentik-Email"
    # Optional: redirect after logout from Mailu.
    # proxyAuthLogoutUrl: "https://auth.tukangketik.net/application/o/authorize/..."

  front:
    hostPort:
      enabled: false

    externalService:
      enabled: true
      type: LoadBalancer
      externalTrafficPolicy: Local
      # Use port 587 (submission/STARTTLS) for client auth; disable legacy 465 (SMTPS).
      ports:
        smtps: false # 465 - implicit TLS (legacy)
        submission: true # 587 - STARTTLS (recommended)

    # Use "mail" so the front listens on 80 for HTTP (Traefik) and enables TLS for mail (587 STARTTLS).
    # With notls, port 587 is never started (it requires STARTTLS). mail uses /certs (mailu-certificates).
    extraEnvVars:
      - name: TLS_FLAVOR
        value: mail
      # Real IP and proxy auth (used when authentik.enabled; whitelist must include Traefik).
      - name: REAL_IP_HEADER
        value: X-Forwarded-For
      - name: REAL_IP_FROM
        value: "10.42.1.0/24"
      - name: PROXY_AUTH_WHITELIST
        value: "10.42.1.0/24"
      - name: PROXY_AUTH_HEADER
        value: "X-Authentik-Email"
      # - name: PROXY_AUTH_CREATE
      #   value: "false"
      # - name: PROXY_AUTH_LOGOUT_URL
      #   value: "https://auth.tukangketik.net/..."

  # Admin needs same proxy auth env so /admin accepts header-based auth.
  admin:
    extraEnvVars:
      - name: REAL_IP_HEADER
        value: X-Forwarded-For
      - name: REAL_IP_FROM
        value: "10.42.1.0/24"
      - name: PROXY_AUTH_WHITELIST
        value: "10.42.1.0/24"
      - name: PROXY_AUTH_HEADER
        value: "X-Authentik-Email"

  smtp:
    enabled: true

  imap:
    enabled: true

  pop3:
    enabled: false
