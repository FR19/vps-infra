apiVersion: apps/v1
kind: Deployment
metadata:
  name: incluster-vpn
  namespace: incluster-vpn
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: incluster-vpn
  template:
    metadata:
      labels:
        app.kubernetes.io/name: incluster-vpn
    spec:
      serviceAccountName: incluster-vpn
      containers:
        - name: tailscale
          image: ghcr.io/tailscale/tailscale:stable
          imagePullPolicy: IfNotPresent
          env:
            - name: TS_AUTHKEY
              valueFrom:
                secretKeyRef:
                  name: incluster-vpn-ts-authkey
                  key: TS_AUTHKEY
            - name: TS_HOSTNAME
              value: incluster-vpn
            - name: TS_STATE_DIR
              value: /var/lib/tailscale
            # Use a dedicated Secret name for tailscaled state in this namespace.
            - name: TS_KUBE_SECRET
              value: incluster-vpn-tailscale
            - name: TS_EXTRA_ARGS
              value: --login-server=https://headscale.tukangketik.net --accept-dns=false
            # Enable tailscaled debug Events in this namespace.
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
          securityContext:
            runAsUser: 0
            capabilities:
              add: [NET_ADMIN, NET_RAW]
          volumeMounts:
            - name: tailscale-state
              mountPath: /var/lib/tailscale
            - name: dev-net-tun
              mountPath: /dev/net/tun
        - name: caddy
          image: caddy:2-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - name: https
              containerPort: 443
              protocol: TCP
          volumeMounts:
            - name: caddyfile
              mountPath: /etc/caddy/Caddyfile
              subPath: Caddyfile
            - name: argocd-tls
              mountPath: /certs/argocd
              readOnly: true
      volumes:
        - name: tailscale-state
          persistentVolumeClaim:
            claimName: incluster-vpn-tailscale-state
        - name: dev-net-tun
          hostPath:
            path: /dev/net/tun
            type: CharDevice
        - name: caddyfile
          configMap:
            name: incluster-vpn-caddy
        - name: argocd-tls
          secret:
            secretName: incluster-vpn-argocd-tls
