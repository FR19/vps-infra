# SOGo main config. IMAP/SMTP point to Stalwart; auth via Authentik LDAP.
# Create secret: kubectl create secret generic sogo-ldap-bind -n sogo --from-literal=bindpw='<ldap-service-account-password>'
apiVersion: v1
kind: ConfigMap
metadata:
  name: sogo-config
  namespace: sogo
  labels:
    app.kubernetes.io/name: sogo
data:
  # SOGo requires OpenStep plist format: entire file must be a root dictionary wrapped in { }.
  # See https://www.sogo.nu/files/docs/SOGoInstallationGuide.html (sogo.conf format).
  sogo.conf: |
    {
      SOGoProfileURL = "ldap://ak-outpost-ldap-outpost.auth.svc.cluster.local:389/dc=ldap,dc=goauthentik,dc=io?cn?sub?(objectClass=user)";
      SOGoUserSources = (
        {
          type = ldap;
          id = directory;
          displayName = "Authentik";
          hostname = "ak-outpost-ldap-outpost.auth.svc.cluster.local";
          port = 389;
          baseDN = "ou=users,dc=ldap,dc=goauthentik,dc=io";
          bindDN = "cn=ldapservice,ou=users,dc=ldap,dc=goauthentik,dc=io";
          bindPasswordFile = "/run/sogo-secrets/ldap-bind-password";
          filter = "objectClass=user";
          CN = "cn";
          UID = "cn";
          mail = "mail";
          searchField = "cn";
        }
      );
      SOGoIMAPServer = "stalwart-mail.mail.svc.cluster.local";
      SOGoSMTPServer = "stalwart-mail.mail.svc.cluster.local";
      SOGoMailingMechanism = smtp;
      SOGoAuthenticationType = LDAP;
      SOGoPageTitle = "Mail";
      SOGoUIAdditionalLanguages = ( "en" );
    }
