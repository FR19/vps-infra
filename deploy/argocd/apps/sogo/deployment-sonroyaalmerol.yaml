# Alternative SOGo deployment using sonroyaalmerol/docker-sogo.
# This image is built for Kubernetes: entrypoint creates /var/run/sogo etc. with correct
# ownership (sogo:sogo), and accepts YAML config in /etc/sogo/sogo.conf.d/.
# To use: replace deployment.yaml with this in kustomization.yaml, add configmap-sogo.conf.d.yaml
# to kustomization, and use the ConfigMap name sogo-config-yaml for the config volume.
# See docs/sogo-sonroyaalmerol.md.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sogo
  namespace: sogo
  labels:
    app.kubernetes.io/name: sogo
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: sogo
  template:
    metadata:
      labels:
        app.kubernetes.io/name: sogo
    spec:
      containers:
        - name: sogo
          image: sonroyaalmerol/docker-sogo:5.12.4-3
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: run
              mountPath: /run
            - name: ldap-bind
              mountPath: /run/sogo-secrets
              readOnly: true
            - name: sogo-config-yaml
              mountPath: /etc/sogo/sogo.conf.d/99-config.yaml
              subPath: "99-config.yaml"
              readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - 'curl -s -o /dev/null -w "%{http_code}" http://localhost/SOGo | grep -E "^(2|3)[0-9]{2}$"'
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - 'curl -s -o /dev/null -w "%{http_code}" http://localhost/SOGo | grep -E "^(2|3)[0-9]{2}$"'
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: run
          emptyDir: {}
        - name: ldap-bind
          secret:
            secretName: sogo-ldap-bind
            items:
              - key: bindpw
                path: ldap-bind-password
        - name: sogo-config-yaml
          configMap:
            name: sogo-config-yaml
