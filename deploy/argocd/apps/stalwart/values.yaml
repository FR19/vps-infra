# Wrapper chart: subchart values under stalwart-mail. We use Traefik IngressRoute (templates/) instead of standard Ingress.
# Chart 0.4.9 / app v0.15.5 is current as of Feb 2026.
# Create secret before sync: kubectl create secret generic stalwart-ldap-bind -n mail --from-literal=LDAP_BIND_PASSWORD='<service-account-password>'
# See docs/authentik-ldap-mail-setup.md for Authentik LDAP provider + outpost.

# Hostname for Stalwart webadmin (used by wrapper IngressRoute).
hostname: mail.tukangketik.net

stalwart-mail:
  replicaCount: 1
  image:
    tag: "v0.15.5"

  # Disable init-container backup to avoid long first startup (init can take many minutes).
  backup:
    enabled: false

  # Allow time for first-time webadmin zip download so pod can become Ready (avoids Argo CD stuck Progressing).
  readinessProbe:
    httpGet:
      path: "/healthz/ready"
      port: "http"
      httpHeaders:
        - name: "X-Forwarded-For"
          value: "127.0.0.1"
    initialDelaySeconds: 90
    periodSeconds: 10

  # cert-manager Certificate creates secret stalwart-tls (subchart). IngressRoute (wrapper) uses same secret.
  certificate:
    certmanager:
      enabled: true
      dnsNames:
        - mail.tukangketik.net
      issuerRef:
        name: letsencrypt-prod
        kind: ClusterIssuer

  persistence:
    enabled: true
    size: 10Gi

  # NodePort: Stalwart's LoadBalancer would expose 80/443 (webadmin) + 25/587/993 (mail). Traefik's
  # svclb already holds 80 and 443, so svclb-stalwart cannot be scheduled ("didn't have free ports").
  # NodePort avoids svclb; webadmin stays via Traefik IngressRoute. Open NodePorts in firewall for mail.
  service:
    type: NodePort

  # We use Traefik IngressRoute (wrapper templates/stalwart-web-ingressroute.yaml), not standard Ingress.
  ingress:
    enabled: false

  # Directory: Authentik LDAP outpost (create in Authentik UI; outpost service name usually ak-outpost-ldap in auth namespace)
  config:
    # So our custom config keys are written to config file (not only to DB). Required for webadmin.resource.
    config:
      local-keys:
        - "store.*"
        - "directory.*"
        - "tracer.*"
        - "!server.blocked-ip.*"
        - "server.*"
        - "authentication.fallback-admin.*"
        - "cluster.*"
        - "config.local-keys.*"
        - "storage.data"
        - "storage.blob"
        - "storage.lookup"
        - "storage.fts"
        - "storage.directory"
        - "certificate.*"
        - "server.allowed-ip.*"
        - "metrics.prometheus.*"
        - "auth.dkim.sign.*"
        - "auth.dkim.verify"
        - "http.use-x-forwarded"
        - "http.permissive-cors"
        - "report.domain"
        - "webadmin.resource"
    # Allow browser from webmail.tukangketik.net to call JMAP at mail.tukangketik.net (CORS).
    http:
      permissive-cors: true
    # Direct webadmin zip URL (avoids GitHub /latest redirect which often fails from pods). Key is webadmin.resource per Stalwart docs.
    webadmin:
      resource: "https://github.com/stalwartlabs/webadmin/releases/download/v0.1.37/webadmin.zip"
    # Default directory: "oidc" = JMAP webmail OAuth works (Stalwart validates Bearer via Authentik UserInfo); "ldap" = IMAP/SMTP password auth. Only one default.
    storage:
      directory: "oidc"
    directory:
      # OIDC: validate Bearer token from jmap-webmail via Authentik UserInfo. Required for webmail OAuth (fixes 401 on /jmap/session).
      oidc:
        type: "oidc"
        timeout: "5s"
        endpoint:
          url: "https://auth.tukangketik.net/application/o/userinfo/"
          method: "userinfo"
        fields:
          email: "email"
          username: "preferred_username"
          full-name: "name"
      ldap:
        type: "ldap"
        url: "ldap://ak-outpost-ldap-outpost.auth.svc.cluster.local:389"
        base-dn: "dc=ldap,dc=goauthentik,dc=io"
        bind:
          dn: "cn=ldapservice,ou=users,dc=ldap,dc=goauthentik,dc=io"
          secret: "%{env:LDAP_BIND_PASSWORD}%"
          auth:
            method: "lookup"
        filter:
          name: "(&(objectClass=user)(|(cn=?)(mail=?)))"
          email: "(&(objectClass=user)(|(mail=?)(mailAlias=?)))"
        attributes:
          name: "cn"
          email: "mail"
          secret-changed: "pwdChangedTime"

  # LDAP bind password from secret (create stalwart-ldap-bind with key LDAP_BIND_PASSWORD)
  secrets:
    create: true
    env: {}
  envFrom:
    - secretRef:
        name: stalwart-ldap-bind
