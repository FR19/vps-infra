# Headscale (Tailscale control server) — headscale.tukangketik.net
# MagicDNS base: vpn.tukangketik.net (must differ from server_url host)

image:
  repository: ghcr.io/juanfont/headscale
  tag: v0.28.0
  pullPolicy: IfNotPresent

env:
  # CLI needs a config file; init writes one to persistence mount. Point CLI at it.
  HEADSCALE_CONFIG: "/var/lib/headscale/config.yaml"
  HEADSCALE_SERVER_URL: "https://headscale.tukangketik.net"
  HEADSCALE_DNS_BASE_DOMAIN: "vpn.tukangketik.net"
  HEADSCALE_DNS_MAGIC_DNS: "true"
  HEADSCALE_DNS_NAMESERVERS_GLOBAL: "1.1.1.1 1.0.0.1"
  HEADSCALE_DNS_OVERRIDE_LOCAL_DNS: "true"
  HEADSCALE_PREFIXES_V4: "100.64.0.0/10"
  HEADSCALE_PREFIXES_V6: "fd7a:115c:a1e0::/48"
  # DERP: avoid fetching from URL (cluster egress often gets TLS interception → cert for traefik.default).
  # Use embedded DERP only; open UDP 3478 on the VPS firewall (see docs/vpn-headscale.md).
  # Empty string: Headscale uses viper.GetStringSlice("derp.urls"); viper uses cast.ToStringSlice; for string, cast uses strings.Fields("") → [] (empty). Do not use "[]" or it is treated as a single URL and fails with "unsupported protocol scheme".
  HEADSCALE_DERP_URLS: "https://controlplane.tailscale.com/derpmap/default"
  HEADSCALE_DERP_AUTO_UPDATE_ENABLED: "false"
  HEADSCALE_DERP_SERVER_ENABLED: "false"
  HEADSCALE_DERP_SERVER_STUN_LISTEN_ADDR: "0.0.0.0:3478"
  HEADSCALE_DERP_SERVER_PRIVATE_KEY_PATH: "/var/lib/headscale/derp_server_private.key"
  HEADSCALE_DERP_SERVER_IPV4: "135.125.131.209" # Set to your VPS public IPv4 for stable DERP (e.g. in values or override).
  HEADSCALE_DERP_SERVER_IPV6: "2001:41d0:701:1100::b9e3" # Optional: VPS public IPv6.
  HEADSCALE_EPHEMERAL_NODE_INACTIVITY_TIMEOUT: "30m"
  HEADSCALE_DISABLE_CHECK_UPDATES: "true"
  # OIDC (Authentik SSO): set issuer and client_id; set HEADSCALE_OIDC_CLIENT_SECRET via Secret (see docs/headscale-authentik-sso.md).
  HEADSCALE_OIDC_ISSUER: "https://auth.tukangketik.net/application/o/headscale/"
  HEADSCALE_OIDC_CLIENT_ID: "rt5cNGqJ4kIMmn1iVkL66oIPi4LMVlOie1rHhc02"
  # HEADSCALE_OIDC_CLIENT_SECRET: set via kubectl or Secret (do not commit). Example: kubectl create secret generic headscale-oidc -n headscale --from-literal=client-secret='YOUR_SECRET'
  HEADSCALE_OIDC_SCOPE: '["openid","profile","email","groups"]'
  HEADSCALE_OIDC_PKCE_ENABLED: "true"
  HEADSCALE_OIDC_PKCE_METHOD: "S256"
  # ACL policy stored in DB; manage via Headplane UI or Headscale API (see docs/vpn-headscale.md).
  HEADSCALE_POLICY_MODE: "database"

service:
  main:
    ports:
      http:
        port: 8080
      metrics:
        port: 9090
      grpc:
        enabled: false

# Persist SQLite DB and keys
persistence:
  config:
    enabled: true
    mountPath: /var/lib/headscale
    size: 1Gi
    retain: true

# Ingress disabled: we use Traefik IngressRoute (headscale-ingressroute.yaml) + Certificate (headscale-certificate.yaml).
ingress:
  main:
    enabled: false

# ACL: policy.mode is "database" (HEADSCALE_POLICY_MODE above). Policy is managed in the DB via
# Headplane UI (headplane.tukangketik.net) or Headscale API; file-based ACL configMap is disabled.
# To restore the previous file-based policy in the DB, use Headplane → ACL/Policy or:
#   curl -H "Authorization: Bearer $API_KEY" -X POST https://headscale.tukangketik.net/api/v1/policy -d @policy.json
# Example policy (groups, tagOwners, acls) is in docs/vpn-headscale.md.
configMaps:
  acl:
    enabled: false
    # data:
    #   policy: |
    #     {
    #       "groups": {
    #         "group:admins": ["president@"]
    #       },
    #       "tagOwners": {
    #         "tag:vps": ["group:admins"]
    #       },
    #       "acls": [
    #         {
    #           "action": "accept",
    #           "src": ["autogroup:member"],
    #           "dst": ["tag:vps:443", "tag:vps:22"]
    #         }
    #       ]
    #     }
  dns:
    enabled: true
    data:
      # Placeholder: replace 100.64.0.1 with your VPS Tailnet IP after enrolling the VPS (see docs/vpn-headscale.md)
      magicDNS: true
      nameservers: ["100.100.100.100"]
      domains: ["tukangketik.net"]
      records: |
        [
          {"name": "argocd.tukangketik.net", "type": "A", "value": "100.64.0.1"}
        ]

# Optional: use PostgreSQL as Headscale's main DB (users, nodes, keys, and policy when policy.mode=database).
# Not required for policy.mode=database — that only means "store ACL in the same DB Headscale uses" (here: SQLite on the persistence volume).
# Headscale recommends SQLite; Postgres is legacy. Leave disabled unless you need a shared DB.
postgresql:
  enabled: false
