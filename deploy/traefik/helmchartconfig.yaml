# K3s HelmChartConfig: enable Traefik CRD provider allowCrossNamespace.
# Required for Mailu+Authentik so the callback route (mailu -> auth/authentik-server) works.
# Apply once: kubectl apply -f deploy/traefik/k3s-allow-cross-namespace.yaml
# Then restart Traefik: kubectl rollout restart deployment -n kube-system -l app.kubernetes.io/name=traefik
# See: https://doc.traefik.io/traefik/v2.4/providers/kubernetes-crd/#allowcrossnamespace
---
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    # Ensure Traefik uses in-cluster DNS even if it runs with hostNetwork.
    # Without this, Kubernetes service names may resolve via public DNS (and break ForwardAuth to Authentik outpost).
    deployment:
      dnsPolicy: ClusterFirstWithHostNet

    # Allow IngressRoutes to reference Services (and other resources) in other namespaces.
    # E.g. mailu IngressRoute -> auth/authentik-server for /outpost.goauthentik.io/*
    providers:
      kubernetesCRD:
        allowCrossNamespace: true
    additionalArguments:
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
