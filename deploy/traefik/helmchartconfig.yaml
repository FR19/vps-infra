# K3s HelmChartConfig: enable Traefik CRD provider allowCrossNamespace + TCP entrypoints for Stalwart mail.
# Required for Mailu+Authentik so the callback route (mailu -> auth/authentik-server) works.
# TCP entrypoints smtp/submission/imaps (25, 587, 993) are used by Stalwart IngressRouteTCP; Traefik must be able to bind (e.g. hostNetwork).
# Apply once: kubectl apply -f deploy/traefik/k3s-allow-cross-namespace.yaml
# After changing this file: kubectl apply -f deploy/traefik/helmchartconfig.yaml && kubectl rollout restart deployment -n kube-system -l app.kubernetes.io/name=traefik
---
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    # Ensure Traefik uses in-cluster DNS even if it runs with hostNetwork.
    # Without this, Kubernetes service names may resolve via public DNS (and break ForwardAuth to Authentik outpost).
    deployment:
      dnsPolicy: ClusterFirstWithHostNet

    # Allow IngressRoutes to reference Services (and other resources) in other namespaces.
    # E.g. mailu IngressRoute -> auth/authentik-server for /outpost.goauthentik.io/*
    providers:
      kubernetesCRD:
        allowCrossNamespace: true
    # TCP entrypoints for Stalwart mail (25, 587, 993). Traefik must bind these (e.g. hostNetwork); then use IngressRouteTCP to forward to Stalwart.
    additionalArguments:
      - "--entrypoints.smtp.address=:25"
      - "--entrypoints.submission.address=:587"
      - "--entrypoints.imaps.address=:993"
